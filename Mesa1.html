<script type="module">
    // Importar Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

    // Configuraci칩n de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAeSHr1HjyaLBaY-H47y0LleeG99w8dRcc",
        authDomain: "velada-255a6.firebaseapp.com",
        projectId: "velada-255a6",
        storageBucket: "velada-255a6.appspot.com",
        messagingSenderId: "604033105183",
        appId: "1:604033105183:web:1b80a81c207b25b3f9842a",
        measurementId: "G-7GZMGGX0W3"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const seatingChart = document.getElementById('seating-chart');
    const pageId = "mesa1"; // ID de la mesa

    // Referencia a la mesa en Firestore
    const seatsRef = doc(db, "asientos", pageId);

    // Escuchar cambios en tiempo real
    onSnapshot(seatsRef, (snapshot) => {
        const savedSeats = snapshot.exists() ? snapshot.data() : {};

        // Limpiar contenido antes de renderizar
        seatingChart.innerHTML = ""; 

        for (let i = 1; i <= 8; i++) {
            let seat = document.createElement('div');
            seat.classList.add('seat');
            seat.textContent = i;

            // Verificar si el asiento est치 ocupado o disponible
            if (savedSeats[`asiento${i}`]) {
                seat.classList.add('occupied');
                seat.setAttribute('data-info', savedSeats[`asiento${i}`]);
                seat.style.cursor = 'not-allowed';
            } else {
                seat.classList.add('available');
                seat.setAttribute('data-info', 'Disponible');
            }

            // Tooltip para mostrar informaci칩n del asiento
            let tooltip = document.createElement('div');
            tooltip.classList.add('tooltip');
            tooltip.textContent = seat.getAttribute('data-info');
            seat.appendChild(tooltip);

            // Evento para seleccionar un asiento
            seat.addEventListener('click', function () {
                if (seat.classList.contains('occupied')) {
                    alert(seat.getAttribute('data-info'));
                } else {
                    seat.classList.toggle('selected');
                }
            });

            // Evento para comprar asiento (doble clic)
            seat.addEventListener('dblclick', async function () {
                let password = prompt("Introduce la clave de administrador");
                if (password === "admin123") {
                    let newName = prompt("Introduce el nombre del comprador:", seat.getAttribute('data-info'));
                    if (newName) {
                        seat.setAttribute('data-info', `Comprado por: ${newName}`);
                        tooltip.textContent = `Comprado por: ${newName}`;
                        seat.classList.remove('available');
                        seat.classList.add('occupied');
                        seat.style.cursor = 'not-allowed';

                        // Guardar la informaci칩n del asiento en Firestore
                        await setDoc(seatsRef, {
                            ...savedSeats,
                            [`asiento${i}`]: `Comprado por: ${newName}`
                        });
                    }
                } else {
                    alert("Clave incorrecta");
                }
            });

            seatingChart.appendChild(seat);
        }
    });
</script>
